<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>FGO Banners</title>
    <style type="text/css">
    html, body { height: 99%; margin: 0; padding: 20px; font-family: sans-serif; margin-top: 3px; text-align: center; }
    a { text-decoration: none; margin: 0; padding: 0; }
    table { border: 3px solid; width: 100%; }
    td { border: 1px solid; }
    .header { margin-top: 5px!important; }
    </style>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        // Load the Visualization API and the corechart package.
        google.charts.load('current', {'packages':['corechart']});

        // Set a callback to run when the Google Visualization API is loaded.
        google.charts.setOnLoadCallback(initialize);

        function initialize() {
            // Add event listeners to buttons
            document.getElementById('fetchSaber').addEventListener('click', () => fetchSpreadsheetData('Saber'));
            document.getElementById('fetchLancer').addEventListener('click', () => fetchSpreadsheetData('Lancer'));
            document.getElementById('fetchArcher').addEventListener('click', () => fetchSpreadsheetData('Archer'));
            document.getElementById('fetchRider').addEventListener('click', () => fetchSpreadsheetData('Rider'));
            document.getElementById('fetchCaster').addEventListener('click', () => fetchSpreadsheetData('Caster'));
            document.getElementById('fetchAssassin').addEventListener('click', () => fetchSpreadsheetData('Assassin'));
            document.getElementById('fetchBerserker').addEventListener('click', () => fetchSpreadsheetData('Berserker'));
            document.getElementById('fetchExtra').addEventListener('click', () => fetchSpreadsheetData('EXTRA'));
        }

        function fetchSpreadsheetData(sheetName) {
            const spreadsheetId = '1rKtRX3WK9ZpbEHhDTy7yGSxYWIav1Hr_KhNM0jWN2wc';
            const query = new google.visualization.Query(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?sheet=${sheetName}`);

            // Send the query with a callback function
            query.send(response => handleQueryResponse(response, sheetName));
        }

        function handleQueryResponse(response, sheetName) {
            if (response.isError()) {
                console.error('Error fetching data:', response.getMessage());
                return;
            }

            const data = response.getDataTable();
            console.log(`Data from ${sheetName}:`, data);

            // Process the data to extract both hyperlink target and display text
            const processedData = processData(data);
            console.log(`Processed data from ${sheetName}:`, processedData);

            // Display the processed data
            displayData(processedData, sheetName);
        }

        function processData(dataTable) {
            const numRows = dataTable.getNumberOfRows();
            const numCols = dataTable.getNumberOfColumns();
            const processedRows = [];

            for (let row = 0; row < numRows; row++) {
                const rowData = [];
                for (let col = 0; col < numCols; col++) {
                    const cellValue = dataTable.getValue(row, col);
                    const cellFormattedValue = dataTable.getFormattedValue(row, col);
                    
                    // Check if the cell contains a hyperlink formula
                    if (cellFormattedValue.startsWith('=HYPERLINK')) {
                        const match = cellFormattedValue.match(/=HYPERLINK\("([^"]+)"\s*,\s*"([^"]+)"\)/);
                        if (match) {
                            const url = match[1];
                            const displayText = match[2];
                            rowData.push({ url, displayText });
                        } else {
                            rowData.push(cellValue); // Fallback to cell value if parsing fails
                        }
                    } else {
                        rowData.push(cellValue);
                    }
                }
                processedRows.push(rowData);
            }
            return processedRows;
        }

        function displayData(processedData, sheetName) {
            const container = document.getElementById('data-container');
            container.innerHTML = ''; // Clear previous data
            const sheetDiv = document.createElement('div');
            sheetDiv.innerHTML = `<h3>${sheetName}</h3>`;
            processedData.forEach(row => {
                const rowDiv = document.createElement('div');
                row.forEach(cell => {
                    if (typeof cell === 'object' && cell.hasOwn('url') && cell.hasOwn('displayText')) {
                        const link = document.createElement('a');
                        link.href = cell.url;
                        link.textContent = cell.displayText;
                        rowDiv.appendChild(link);
                    } else {
                        const span = document.createElement('span');
                        span.textContent = cell + ' ';
                        rowDiv.appendChild(span);
                    }
                });
                sheetDiv.appendChild(rowDiv);
            });
            container.appendChild(sheetDiv);
        }
    </script>
</head>
<body>
    <button id="fetchSaber">Saber</button>
    <button id="fetchLancer">Lancer</button>
    <button id="fetchArcher">Archer</button>
    <button id="fetchRider">Rider</button>
    <button id="fetchCaster">Caster</button>
    <button id="fetchAssassin">Assassin</button>
    <button id="fetchBerserker">Berserker</button>
    <button id="fetchExtra">EXTRA</button>
    <table>
        <thead>
            <tr>
                <th>Table</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td id="data-container">&nbsp;</td>
            </tr>
        </tbody>
    </table>
</body>
</html>
